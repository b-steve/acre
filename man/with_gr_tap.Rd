% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/functions_in_fit.R
\name{with_gr_tap}
\alias{with_gr_tap}
\title{Wrap a gradient to emit buffered trace rows (mgc) on each evaluation}
\usage{
with_gr_tap(gr, tap, par_names, G_matrix_list)
}
\arguments{
\item{gr}{Gradient function with signature \verb{function(par, ...) -> numeric}
(same length/order as \code{par}), or \code{NULL} if no gradient is supplied.}

\item{tap}{Tap/list returned by \code{\link[=make_buffer_printer]{make_buffer_printer()}}, expected to provide
a method \code{on_gr_evaluation(par_vec, grad_vec, par_names)}.}

\item{par_names}{Character vector of names corresponding to \code{par}. These are
used by the tap to map gradient components to parameter columns.}

\item{G_matrix_list}{List of back-transformation matrices used to back
transform parameter values in the case they have been scaled and centered
for model fitting.}
}
\value{
A function with the same signature and return value as \code{gr},
which also triggers the tap side-effect after each evaluation; or \code{NULL}
if \code{gr} was \code{NULL}.
}
\description{
Creates an idempotent wrapper around a gradient function \code{gr(par, ...)}
that forwards the call unchanged, then notifies a tap object produced by
\code{\link[=make_buffer_printer]{make_buffer_printer()}} via \code{tap$on_gr_evaluation(par_vec, grad_vec, par_names)}.
When used together with \code{\link[=with_fn_tap]{with_fn_tap()}}, the tap can pair \code{fn} and \code{gr}
evaluations at the same parameter vector and print a trace row that includes
\code{mgc = max(abs(grad))}.
}
\details{
If \code{gr} is \code{NULL}, this helper returns \code{NULL} (no wrapping).
The wrapper is \strong{idempotent}: if it detects the function was already wrapped
(attribute \code{.__gr_tapped}), it returns \code{gr} unchanged. Arguments are
\code{force()}d so the wrapper closes over the current objects.
}
\seealso{
\code{\link[=with_fn_tap]{with_fn_tap()}}, \code{\link[=make_buffer_printer]{make_buffer_printer()}}, \code{\link[stats:nlminb]{stats::nlminb()}}
}
